<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CAL Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/index.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body>
  <div class="sidebar">
    <h2>CAL Dashboard</h2>
    <div class="nav-item" data-target="dashboard">Master</div>
    <div class="nav-item" data-target="upload">Upload</div>
    <div class="nav-item" data-target="history">History</div>
    <div class="nav-item" data-target="settings">Settings</div>
    <div class="nav-item" data-target="agents">Agents</div>
    <div class="nav-item" onclick="window.location.href='/workflow-dashboard'">Workflow Dashboard</div>
    <div class="nav-item" onclick="window.location.href='/simple-report-generator'">Report Generator</div>
    <div class="nav-item" onclick="window.location.href='/feedback-display'">Feedback Intelligence</div>
    <div class="nav-item" onclick="window.location.href='/feedback-input'">Submit Feedback</div>
    <div class="nav-item" onclick="window.location.href='/market-research'">Market Research</div>
  </div>
  <div class="main">
    <!-- Dashboard -->
    <section id="dashboard" class="active">
      <div class="header">
        <h1>Dashboard</h1>
        <input type="search" placeholder="Search..." />
      </div>
      <div class="upload-panel">Drag & Drop to Upload Notes or Click to Browse</div>
      <div class="prompt-panel">
        <textarea placeholder="Enter your prompt here..."></textarea>
        <div class="prompt-footer">
          <div class="select-group">
            <label for="taskTypeSelect">Task Type:</label>
            <select id="taskTypeSelect">
              <option value="general">General</option>
              <option value="market_research">Market Research</option>
              <option value="competitor_analysis">Competitor Analysis</option>
              <option value="technical_analysis">Technical Analysis</option>
              <option value="business_strategy">Business Strategy</option>
              <option value="customer_communication">Customer Communication</option>
              <option value="document_creation">Document Creation</option>
              <option value="professional_development">Professional Development</option>
            </select>
          </div>
          <div class="select-group">
            <label for="modelSelect">Provider:</label>
            <select id="modelSelect">
              <option value="openai">OpenAI</option>
              <option value="google">Google</option>
              <option value="perplexity">Perplexity</option>
            </select>
          </div>
          <div class="select-group">
            <label for="verificationToggle">
              <input type="checkbox" id="verificationToggle" checked> Fact Verification
            </label>
          </div>
          <div class="select-group">
            <label for="feedbackToggle">
              <input type="checkbox" id="feedbackToggle" checked> Apply Feedback
            </label>
          </div>
          <button>Submit to Orchestrator</button>
        </div>
      </div>
      <!-- Response Section -->
      <div class="response-panel" id="responsePanel"></div>
      <!-- History Detail Card -->
      <div class="history-detail-card" id="historyDetailCard" style="display: none;"></div>
    </section>
    <!-- Agents -->
    <section id="agents">
      <h2>Collaborative Agent Network</h2>
      <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <strong>ü§ñ Unified Orchestrator:</strong> All agents now work collaboratively through the Agent Orchestrator, 
        automatically selecting optimal combinations based on task type, applying feedback context, and performing 
        fact verification for enhanced accuracy and reliability.
      </div>
      <div class="agents-list">
        <div class="card">
          <h3>üéØ TrendTracker</h3>
          <p><strong>Market Research & Intelligence:</strong> Monitors market trends, government solicitations, and industry programs. 
          Specializes in fact-verified research with source reliability tracking. Collaborates with Engineer and Sales for comprehensive analysis.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Market trend analysis<br>‚Ä¢ Government solicitation monitoring<br>‚Ä¢ Industry intelligence<br>‚Ä¢ Source verification</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>Engineer, RivalWatcher, Sales</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üîß Engineer</h3>
          <p><strong>Technical Analysis & Verification:</strong> Provides deep technical insights, validates specifications, 
          and ensures technical accuracy. Integrates feedback on technical depth and implementation requirements.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Technical specification analysis<br>‚Ä¢ Engineering best practices<br>‚Ä¢ System design insights<br>‚Ä¢ Technical fact verification</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>TrendTracker, TechWiz, Sales</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üïµÔ∏è RivalWatcher</h3>
          <p><strong>Competitive Intelligence:</strong> Monitors competitors, analyzes competitive landscape, 
          and provides strategic insights. Ensures all competitive claims are fact-verified with reliable sources.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Competitor monitoring<br>‚Ä¢ Competitive analysis<br>‚Ä¢ Strategic intelligence<br>‚Ä¢ Market positioning</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>TrendTracker, Engineer, Sales</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üíº Sales</h3>
          <p><strong>Business Strategy & Opportunities:</strong> Identifies business opportunities, analyzes revenue potential, 
          and provides strategic recommendations. Applies feedback on business focus and customer needs.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Business opportunity analysis<br>‚Ä¢ Revenue optimization<br>‚Ä¢ Strategic planning<br>‚Ä¢ Customer needs assessment</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>TrendTracker, Engineer, RivalWatcher</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>‚úçÔ∏è Editor</h3>
          <p><strong>Content Quality & Style:</strong> Ensures consistent writing style, proper formatting, 
          and content quality. Integrates presentation feedback and maintains professional communication standards.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Content editing & review<br>‚Ä¢ Style consistency<br>‚Ä¢ Quality assurance<br>‚Ä¢ Professional formatting</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>DocumentMaster, CustomerConnect</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üßô‚Äç‚ôÇÔ∏è TechWiz</h3>
          <p><strong>Technical Content Creation:</strong> Produces high-quality technical content, proposals, 
          and technical documentation. Collaborates with Engineer for technical accuracy and verification.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Technical writing<br>‚Ä¢ Proposal development<br>‚Ä¢ Technical documentation<br>‚Ä¢ Content creation</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>Engineer, Editor, DocumentMaster</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üìß CustomerConnect</h3>
          <p><strong>Professional Communication:</strong> Drafts professional emails and communications. 
          Applies feedback on presentation skills, tone, and customer connection strategies.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Professional email drafting<br>‚Ä¢ Communication strategy<br>‚Ä¢ Customer engagement<br>‚Ä¢ Presentation support</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>Editor, ProfessionalMentor</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üìö DocumentMaster</h3>
          <p><strong>Document Organization & Management:</strong> Organizes documents, manages templates, 
          and ensures proper document structure. Collaborates with Editor for formatting and quality.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Document organization<br>‚Ä¢ Template management<br>‚Ä¢ Structure optimization<br>‚Ä¢ Content formatting</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>Editor, TechWiz</div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>üéì ProfessionalMentor</h3>
          <p><strong>Performance Coaching & Feedback Integration:</strong> Provides personalized coaching, 
          integrates feedback patterns, and helps improve professional performance across all interactions.</p>
          <div class="details">
            <div class="details-field">
              <label>Capabilities:</label>
              <div>‚Ä¢ Performance coaching<br>‚Ä¢ Feedback integration<br>‚Ä¢ Professional development<br>‚Ä¢ Skill improvement</div>
            </div>
            <div class="details-field">
              <label>Collaborates With:</label>
              <div>All agents for feedback integration</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- History -->
    <section id="history">
      <h1>History</h1>
      <div class="history-list" id="historyList"></div>
    </section>
    <section id="historyDetail">
      <button class="back-btn" id="backBtn">‚Üê Back to History</button>
      <div class="history-detail" id="detailContainer"></div>
    </section>
    <section id="upload">
      <h1>Upload</h1>
    </section>
    <section id="settings">
      <h1>Settings</h1>
    </section>
    <div class="footer">&copy; 2025 CAL Dashboard ‚Ä¢ All rights reserved</div>
  </div>
  <script>
    const navItems = document.querySelectorAll('.nav-item');
    const sections = {
      dashboard: document.getElementById('dashboard'),
      history: document.getElementById('history'),
      historyDetail: document.getElementById('historyDetail'),
      agents: document.getElementById('agents')
    };
    const showSection = key => {
      Object.values(sections).forEach(sec => sec.classList.remove('active'));
      sections[key].classList.add('active');
    };
    navItems.forEach(item => item.addEventListener('click', () => showSection(item.dataset.target)));
    // Load history list using formatted responses
    document.querySelector('[data-target="history"]').addEventListener('click', async () => {
      const list = document.getElementById('historyList'); list.innerHTML = '';
      try {
        const res = await fetch('/api/responses/formatted'); const data = await res.json();
        data.forEach(record => {
          console.log('Raw record:', record);
          
          // Use formatted response structure
          const agent = record.agent_name || 'Unknown';
          const formattedContent = record.formatted_content || record.content || 'No content provided';
          const topicId = record.topic_id || 'N/A';
          const tags = record.tags || [];
          const timestamp = record.timestamp;
          
          console.log('Processed data:', { agent, content: formattedContent.substring(0, 100), topicId, tags, timestamp });
          
          let timestampStr = 'N/A';
          if (timestamp) {
            let date;
            if (timestamp._seconds) {
              date = new Date(timestamp._seconds * 1000);
            } else if (typeof timestamp === 'string') {
              date = new Date(timestamp);
            } else {
              date = new Date(timestamp);
            }
            timestampStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
          }
          
          // Convert markdown content to HTML and then truncate
          const contentHtml = marked.parse(formattedContent);
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = contentHtml;
          const textContent = tempDiv.textContent || tempDiv.innerText || '';
          const truncated = textContent.split(' ').slice(0, 15).join(' ') + (textContent.split(' ').length > 15 ? '...' : '');
          
          const card = document.createElement('div'); card.className = 'card';
          card.innerHTML = `
            <h3>${agent}</h3>
            <p>${truncated}</p>
            ${topicId !== 'N/A' ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">Topic: ${topicId.substring(0, 8)}...</div>` : ''}
            ${tags && tags.length > 0 ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">Tags: ${tags.slice(0, 3).join(', ')}${tags.length > 3 ? '...' : ''}</div>` : ''}
          `;
          card.addEventListener('click', () => {
            const container = document.getElementById('detailContainer'); container.innerHTML = '';
            
            // Display agent and other fields using formatted content
            const fields = [
              ['Agent', agent], 
              ['Content', formattedContent], 
              ['Topic ID', topicId],
              ['Tags', tags.length > 0 ? tags.join(', ') : 'No tags'],
              ['Timestamp', timestampStr]
            ];
            
            fields.forEach(([label, val]) => {
              const fld = document.createElement('div'); fld.className = 'detail-field';
              if (label === 'Content') {
                fld.innerHTML = `<label>${label}:</label><div>${marked.parse(val)}</div>`;
              } else {
                fld.innerHTML = `<label>${label}:</label><div>${val}</div>`;
              }
              container.appendChild(fld);
            });
            showSection('historyDetail');
          });
          list.appendChild(card);
        });
      } catch (e) { 
        console.error('Error loading history:', e);
        list.textContent = 'Failed to load history.'; 
      }
    });
    document.getElementById('backBtn').addEventListener('click', () => showSection('history'));
    
    // Add click handlers for agent cards to show/hide details
    document.addEventListener('click', (e) => {
      if (e.target.closest('.card') && e.target.closest('#agents')) {
        const card = e.target.closest('.card');
        card.classList.toggle('expanded');
      }
    });
    
    // Initialize to dashboard
    showSection('dashboard');
    // Enhanced Submit to Orchestrator API call
    const submitButton = document.querySelector('.prompt-panel button');
    const responsePanel = document.getElementById('responsePanel');
    submitButton.addEventListener('click', async () => {
      const promptText = document.querySelector('.prompt-panel textarea').value;
      const taskType = document.getElementById('taskTypeSelect').value;
      const provider = document.getElementById('modelSelect').value;
      const verificationEnabled = document.getElementById('verificationToggle').checked;
      const feedbackEnabled = document.getElementById('feedbackToggle').checked;
      
      if (!promptText) return alert('Please enter a prompt.');
      
      const payload = { 
        provider: provider, 
        model: 0, 
        response: promptText, 
        additional_context: `Task Type: ${taskType}`, 
        topic_id: '', 
        user_id: 'DLbMxLvPkcPmGJuWYCh0',
        task_type: taskType,
        verification_required: verificationEnabled,
        feedback_context: feedbackEnabled
      };
      
      try {
        submitButton.disabled = true;
        submitButton.textContent = 'Processing with Orchestrator...';
        responsePanel.innerHTML = `
          <div style="color: #3498db; margin-bottom: 10px;">ü§ñ Agent Orchestrator Processing...</div>
          <div style="color: #7f8c8d; font-size: 0.9em;">
            ‚Ä¢ Task Type: ${taskType}<br>
            ‚Ä¢ Fact Verification: ${verificationEnabled ? 'Enabled' : 'Disabled'}<br>
            ‚Ä¢ Feedback Context: ${feedbackEnabled ? 'Applied' : 'Disabled'}<br>
            ‚Ä¢ Determining optimal agents...
          </div>
        `;
        
        const res = await fetch(`/agent`, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(payload) 
        });
        const data = await res.json();
        
        // Enhanced response display with orchestrator details
        let displayContent = '';
        
        if (data.workflow_id) {
          displayContent += `<div style="background: #e8f5e8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>üîÑ Workflow ID:</strong> ${data.workflow_id}<br>
            <strong>ü§ù Agents Involved:</strong> ${data.agents_involved ? data.agents_involved.join(', ') : 'N/A'}<br>
            <strong>üìã Task Type:</strong> ${data.task_type || 'N/A'}<br>
            <strong>üí° Feedback Applied:</strong> ${data.feedback_applied ? data.feedback_applied.join(', ') : 'None'}
          </div>`;
        }
        
        if (data.verification_results) {
          displayContent += `<div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>üîç Verification Results:</strong><br>
            ‚Ä¢ Quality Score: ${data.verification_results.overall_quality_score || 'N/A'}<br>
            ‚Ä¢ Reliability: ${data.verification_results.reliability_score || 'N/A'}<br>
            ‚Ä¢ Verified Sources: ${data.verification_results.verified_sources_count || 0}<br>
            ‚Ä¢ Status: ${data.verification_results.approval_status || 'N/A'}
          </div>`;
        }
        
        if (data.feedback_impact) {
          displayContent += `<div style="background: #fff8e1; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            <strong>üìà Feedback Impact:</strong><br>
            ‚Ä¢ Entries Applied: ${data.feedback_impact.entries_applied || 0}<br>
            ‚Ä¢ Average Relevance: ${data.feedback_impact.average_relevance || 'N/A'}<br>
            ‚Ä¢ Quality Score: ${data.quality_score || 'N/A'}
          </div>`;
        }
        
        displayContent += `<div style="background: #f8f9fa; padding: 15px; border-radius: 5px; border-left: 4px solid #3498db;">
          <strong>üìù Response:</strong><br><br>
          ${marked.parse(data.response || 'No response available')}
        </div>`;
        
        responsePanel.innerHTML = displayContent;

        // Fetch and display latest history entry using formatted response endpoint
        const historyRes = await fetch('/api/responses/formatted?limit=1');
        const historyData = await historyRes.json();
        if (historyData.length > 0) {
          const record = historyData[0];
          // Use the formatted response structure
          const agent = record.agent_name || 'Orchestrator';
          const formattedContent = record.formatted_content || record.content || 'No content provided';
          const topicId = record.topic_id || 'N/A';
          const tags = record.tags || [];
          const timestamp = record.timestamp;
          
          let timestampStr = 'N/A';
          if (timestamp) {
            let date;
            if (timestamp._seconds) {
              date = new Date(timestamp._seconds * 1000);
            } else if (typeof timestamp === 'string') {
              date = new Date(timestamp);
            } else {
              date = new Date(timestamp);
            }
            timestampStr = date.toLocaleString();
          }

          const historyCard = document.getElementById('historyDetailCard');
          historyCard.innerHTML = `
            <h3>Latest Agent Response</h3>
            <div class="detail-field">
              <label>Agent:</label>
              <div>${agent}</div>
            </div>
            <div class="detail-field">
              <label>Topic ID:</label>
              <div>${topicId}</div>
            </div>
            <div class="detail-field">
              <label>Workflow ID:</label>
              <div>${data.workflow_id || 'N/A'}</div>
            </div>
            <div class="detail-field">
              <label>Agents Involved:</label>
              <div>${data.agents_involved ? data.agents_involved.join(', ') : 'N/A'}</div>
            </div>
            <div class="detail-field">
              <label>Tags:</label>
              <div>${tags.length > 0 ? tags.join(', ') : 'No tags'}</div>
            </div>
            <div class="detail-field">
              <label>Content:</label>
              <div>${marked.parse(formattedContent)}</div>
            </div>
            <div class="detail-field">
              <label>Timestamp:</label>
              <div>${timestampStr}</div>
            </div>
          `;
          historyCard.style.display = 'block';
        }
      } catch (error) {
        responsePanel.innerHTML = `<div style="color: #e74c3c; padding: 10px; background: #fadbd8; border-radius: 5px;">
          <strong>‚ùå Error:</strong> Failed to process request through orchestrator.<br>
          <small>${error.message}</small>
        </div>`;
        console.error(error);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Submit to Orchestrator';
      }
    });
  </script>
</body>

</html>
